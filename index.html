<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Somar Pesos por QR</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    h1 { font-size: 20px; }
    .card { border: 1px solid #ccc; border-radius: 6px; padding: 12px; margin: 8px 0; }
    .muted { color: #666; font-size: 12px; }
    .badge { padding: 2px 6px; border-radius: 4px; border: 1px solid #bbb; font-size: 12px; }
  </style>
  <!-- Biblioteca QR antes de tudo -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h1>Leitor de QR — Somatório de Pesos</h1>

  <div class="card">
    <h3>Scanner</h3>
    <div id="reader" style="width: 320px; max-width:100%;"></div>
    <button id="btnStart">Iniciar câmera</button>
    <button id="btnStop">Parar</button>
    <p class="muted">Escaneie QR com: <code>produto</code>, <code>peso_kg</code>, <code>codigo_barras</code>, <code>lote</code>.</p>
  </div>

  <div class="card">
    <h3>Pallet atual</h3>
    ID: <input id="palletId">
    <p><span class="badge">Pacotes: <span id="count">0</span></span>
    <span class="badge">Peso total (kg): <span id="total">0.000</span></span></p>
    <button id="btnFechar">Fechar pallet</button>
  </div>

  <div class="card">
    <h3>Itens</h3>
    <table id="tbl" border="1" width="100%">
      <thead><tr><th>#</th><th>Produto</th><th>Peso</th><th>Cód. Barras</th><th>Lote</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
window.addEventListener("load", () => {
  const state = { current: { id: "", items: [], dedup: new Set() } };
  const $ = id => document.getElementById(id);

  function fmt(n) { return (Math.round(n*1000)/1000).toFixed(3); }
  function updateUI() {
    $("palletId").value = state.current.id;
    $("count").textContent = state.current.items.length;
    $("total").textContent = fmt(state.current.items.reduce((s,i)=>s+i.peso_kg,0));
    const tb = $("tbl").querySelector("tbody");
    tb.innerHTML = "";
    state.current.items.forEach((it,idx)=>{
      tb.innerHTML += `<tr><td>${idx+1}</td><td>${it.produto}</td><td>${fmt(it.peso_kg)}</td><td>${it.codigo_barras}</td><td>${it.lote}</td></tr>`;
    });
  }

  function onScanSuccess(decodedText) {
    if(state.current.dedup.has(decodedText)) return;
    state.current.dedup.add(decodedText);
    let obj;
    try { obj = JSON.parse(decodedText); }
    catch { return alert("QR inválido"); }
    state.current.items.push({
      produto: obj.produto || "",
      peso_kg: parseFloat(obj.peso_kg) || 0,
      codigo_barras: obj.codigo_barras || "",
      lote: obj.lote || ""
    });
    updateUI();
  }

  let html5QrCode;
  $("btnStart").addEventListener("click", () => {
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras.length) {
        html5QrCode.start(
          { deviceId: { exact: cameras[0].id } },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      } else {
        alert("Nenhuma câmera encontrada");
      }
    }).catch(err => alert("Erro câmera: " + err));
  });

  $("btnStop").addEventListener("click", () => {
    if (html5QrCode) html5QrCode.stop();
  });

  $("btnFechar").addEventListener("click", () => {
    state.current = { id: "", items: [], dedup: new Set() };
    updateUI();
  });

  updateUI();
});
</script>
</body>
</html>
